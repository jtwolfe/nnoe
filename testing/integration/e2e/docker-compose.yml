services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: nnoe-etcd-test
    environment:
      - ETCD_NAME=etcd-server
      - ETCD_DATA_DIR=/etcd-data
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_INITIAL_CLUSTER=etcd-server=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster-1
      - ETCD_INITIAL_CLUSTER_STATE=new
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - etcd-data:/etcd-data
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Mock MISP server (simple HTTP server)
  misp-mock:
    image: nginx:alpine
    container_name: nnoe-misp-mock
    ports:
      - "8080:80"
    volumes:
      - ./fixtures/misp-data:/usr/share/nginx/html:ro
    command: |
      sh -c "echo 'server { listen 80; location / { return 200 \"[]\"; add_header Content-Type application/json; } }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  # Agent test container (will run tests)
  agent-test:
    build:
      context: ../../..
      dockerfile: ./testing/integration/e2e/Dockerfile.test
    container_name: nnoe-agent-test
    depends_on:
      etcd:
        condition: service_healthy
    environment:
      - ETCD_ENDPOINTS=http://etcd:2379
      - NODE_NAME=test-agent-1
    volumes:
      - ../../../target:/target:ro
      - test-cache:/var/nnoe/cache
    command: ["/bin/sh", "-c", "cargo test --test e2e_tests --package nnoe-agent"]

volumes:
  etcd-data:
  test-cache:

