FROM rust:1.70 as builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y \
    protobuf-compiler \
    libprotobuf-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy workspace files from repo root (context is ../../.. from compose file location)
COPY Cargo.toml ./
COPY agent/ ./agent/
COPY integrations/misp-sync/ ./integrations/misp-sync/
COPY management/monitoring/prometheus-exporter/ ./management/monitoring/prometheus-exporter/
COPY testing/performance/benchmarks/ ./testing/performance/benchmarks/

# Build dependencies
RUN cargo build --release

# Test image
FROM rust:1.70

WORKDIR /app

# Install test dependencies
RUN apt-get update && apt-get install -y \
    curl \
    protobuf-compiler \
    libprotobuf-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy built artifacts
COPY --from=builder /app/target/release/nnoe-agent /usr/local/bin/
COPY --from=builder /app/target/release/misp-sync /usr/local/bin/

# Copy test files
COPY testing/ ./testing/
COPY agent/ ./agent/
COPY integrations/ ./integrations/

# Set working directory for tests
WORKDIR /app

CMD ["cargo", "test", "--test", "e2e_tests", "--package", "nnoe-agent"]

