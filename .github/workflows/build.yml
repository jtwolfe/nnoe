name: Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-musl
    
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}
    
    - name: Install musl tools
      timeout-minutes: 10
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools musl-dev
        if [ "${{ matrix.target }}" = "aarch64-unknown-linux-musl" ]; then
          # Check if cross-compiler is already cached
          if [ -f /usr/local/bin/aarch64-linux-musl-gcc ] && /usr/local/bin/aarch64-linux-musl-gcc --version >/dev/null 2>&1; then
            echo "Using cached aarch64 cross-compiler"
            /usr/local/bin/aarch64-linux-musl-gcc --version
          else
            # Install musl cross-compiler for aarch64
            # Use curl with retries - musl.cc can be slow/timeout
            echo "Downloading aarch64 musl cross-compiler from musl.cc..."
            MAX_ATTEMPTS=5
            CONNECT_TIMEOUT=60
            MAX_TIME=600
            DOWNLOAD_URL="https://musl.cc/aarch64-linux-musl-cross.tgz"
            
            for i in $(seq 1 $MAX_ATTEMPTS); do
              echo "Attempt $i/$MAX_ATTEMPTS..."
              echo "Download URL: $DOWNLOAD_URL"
              
              # Use timeout command to ensure curl doesn't hang indefinitely
              # Increased timeouts for slow connections to musl.cc
              if timeout $MAX_TIME curl -L --fail \
                  --connect-timeout $CONNECT_TIMEOUT \
                  --max-time $MAX_TIME \
                  --retry 3 \
                  --retry-delay 10 \
                  --progress-bar \
                  --speed-time 60 \
                  --speed-limit 500 \
                  -o aarch64-linux-musl-cross.tgz \
                  "$DOWNLOAD_URL" 2>&1 | tee /tmp/curl_output.log; then
                
                # Verify downloaded file
                if [ -f aarch64-linux-musl-cross.tgz ] && [ -s aarch64-linux-musl-cross.tgz ]; then
                  file_size=$(stat -f%z aarch64-linux-musl-cross.tgz 2>/dev/null || stat -c%s aarch64-linux-musl-cross.tgz 2>/dev/null || echo "0")
                  echo "Download successful on attempt $i (size: $file_size bytes)"
                  if [ "$file_size" -gt 1000000 ]; then
                    break
                  else
                    echo "Downloaded file is too small ($file_size bytes), retrying..."
                    rm -f aarch64-linux-musl-cross.tgz
                  fi
                else
                  echo "Downloaded file is empty or missing, retrying..."
                  rm -f aarch64-linux-musl-cross.tgz
                fi
              else
                curl_exit=$?
                echo "Download failed on attempt $i with exit code $curl_exit"
                if [ $i -lt $MAX_ATTEMPTS ]; then
                  wait_time=$((10 * i))
                  echo "Waiting $wait_time seconds before retry..."
                  sleep $wait_time
                fi
              fi
            done
            
            if [ ! -f aarch64-linux-musl-cross.tgz ] || [ ! -s aarch64-linux-musl-cross.tgz ]; then
              echo "Error: Failed to download cross-compiler after $MAX_ATTEMPTS attempts"
              echo "This may be due to network issues with musl.cc"
              echo "Last curl output:"
              cat /tmp/curl_output.log || echo "No curl output available"
              echo ""
              echo "::warning::aarch64 cross-compiler download failed."
              echo "Consider using the 'cross' crate for more reliable cross-compilation."
              echo "To use cross, add 'cross = "0.6"' to workspace dependencies and change build command to 'cross build --target ${{ matrix.target }} --release'"
              exit 1
            fi
            
            echo "Extracting cross-compiler..."
            sudo tar -xzf aarch64-linux-musl-cross.tgz -C /usr/local --strip-components=1
            rm aarch64-linux-musl-cross.tgz
            
            # Verify installation
            if ! /usr/local/bin/aarch64-linux-musl-gcc --version >/dev/null 2>&1; then
              echo "Error: Compiler installation verification failed"
              echo "Installed files:"
              ls -la /usr/local/bin/aarch64-linux-musl-* || echo "No aarch64 compiler found in /usr/local/bin"
              exit 1
            fi
            echo "Cross-compiler installed successfully:"
            /usr/local/bin/aarch64-linux-musl-gcc --version
          fi
        fi
    
    - name: Install protobuf compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler libprotobuf-dev
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.target }}-
          ${{ runner.os }}-cargo-
    
    - name: Build agent
      timeout-minutes: 20
      run: |
        echo "Building nnoe-agent for ${{ matrix.target }}..."
        if [ "${{ matrix.target }}" = "aarch64-unknown-linux-musl" ]; then
          export PATH="/usr/local/bin:$PATH"
          export CC_aarch64_unknown_linux_musl=aarch64-linux-musl-gcc
        fi
        cargo build --package nnoe-agent --release --target ${{ matrix.target }} || {
          echo "::error::Failed to build nnoe-agent for ${{ matrix.target }}"
          exit 1
        }
        echo "nnoe-agent build successful"
    
    - name: Build misp-sync
      timeout-minutes: 15
      run: |
        echo "Building misp-sync for ${{ matrix.target }}..."
        if [ "${{ matrix.target }}" = "aarch64-unknown-linux-musl" ]; then
          export PATH="/usr/local/bin:$PATH"
          export CC_aarch64_unknown_linux_musl=aarch64-linux-musl-gcc
        fi
        cargo build --package nnoe-misp-sync --release --target ${{ matrix.target }} || {
          echo "::error::Failed to build misp-sync for ${{ matrix.target }}"
          exit 1
        }
        echo "misp-sync build successful"
    
    - name: Build prometheus-exporter
      timeout-minutes: 15
      run: |
        echo "Building prometheus-exporter for ${{ matrix.target }}..."
        if [ "${{ matrix.target }}" = "aarch64-unknown-linux-musl" ]; then
          export PATH="/usr/local/bin:$PATH"
          export CC_aarch64_unknown_linux_musl=aarch64-linux-musl-gcc
        fi
        cargo build --package nnoe-prometheus-exporter --release --target ${{ matrix.target }} || {
          echo "::error::Failed to build prometheus-exporter for ${{ matrix.target }}"
          exit 1
        }
        echo "prometheus-exporter build successful"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.target }}
        path: |
          target/${{ matrix.target }}/release/nnoe-agent
          target/${{ matrix.target }}/release/misp-sync
          target/${{ matrix.target }}/release/nnoe-prometheus-exporter
        retention-days: 30
        compression-level: 6
    
    - name: Verify binaries
      timeout-minutes: 5
      run: |
        echo "Verifying binaries for ${{ matrix.target }}..."
        if [ -f "target/${{ matrix.target }}/release/nnoe-agent" ]; then
          file "target/${{ matrix.target }}/release/nnoe-agent"
          ls -lh "target/${{ matrix.target }}/release/"*.exe 2>/dev/null || ls -lh "target/${{ matrix.target }}/release/nnoe-*" || true
          echo "Binary verification complete"
        else
          echo "::error::Binaries not found"
          exit 1
        fi
