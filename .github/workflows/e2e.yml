name: End-to-End Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e:
    strategy:
      fail-fast: false
      matrix:
        test-scenario: [zone-management, dhcp-scope, threat-blocking]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install protobuf compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler libprotobuf-dev
    
    # Docker Compose v2 is pre-installed on GitHub Actions runners
    # No need to install separately
    
    - name: Verify Docker setup
      working-directory: testing/integration/e2e
      run: |
        echo "Checking docker-compose.yml exists..."
        test -f docker-compose.yml || (echo "docker-compose.yml not found!" && exit 1)
        echo "Checking Dockerfile.test exists..."
        test -f Dockerfile.test || (echo "Dockerfile.test not found!" && exit 1)
        echo "Docker setup verified"
    
    - name: Start test environment
      working-directory: testing/integration/e2e
      run: |
        echo "Starting docker compose services..."
        docker compose up -d --build 2>&1
        echo "Docker compose services started"
    
    - name: Wait for services to be healthy
      working-directory: testing/integration/e2e
      run: |
        echo "Waiting for etcd to be healthy..."
        timeout=60
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if docker compose ps etcd | grep -q "healthy"; then
            echo "etcd is healthy"
            break
          fi
          echo "Waiting for etcd... ($elapsed/$timeout seconds)"
          sleep 2
          elapsed=$((elapsed + 2))
        done
        if [ $elapsed -ge $timeout ]; then
          echo "Error: etcd did not become healthy within $timeout seconds"
          docker compose ps
          docker compose logs etcd
          exit 1
        fi
        echo "All services started"
        docker compose ps
    
    - name: Run integration tests
      working-directory: testing/integration/e2e
      run: |
        echo "Running integration tests for scenario: ${{ matrix.test-scenario }}"
        
        # Run specific test scenario or all tests
        if [ -f "docker-compose.yml" ]; then
          # Start test container with specific test
          docker compose run --rm agent-test cargo test --test ${{ matrix.test-scenario }} -- --nocapture || {
            echo "::error::Integration tests failed for ${{ matrix.test-scenario }}"
            docker compose logs
            exit 1
          }
        else
          echo "Running tests directly..."
          cargo test --test ${{ matrix.test-scenario }} -- --nocapture || {
            echo "::error::Tests failed"
            exit 1
          }
        fi
        
        echo "Tests completed successfully"
    
    - name: Collect logs on failure
      if: failure()
      working-directory: testing/integration/e2e
      run: |
        echo "=== Collecting logs for debugging ==="
        docker compose ps
        docker compose logs
        echo "=== Docker system info ==="
        docker system df
        docker info
    
    - name: Cleanup
      if: always()
      working-directory: testing/integration/e2e
      run: |
        echo "Cleaning up docker compose services..."
        docker compose down -v
        echo "Cleanup complete"
